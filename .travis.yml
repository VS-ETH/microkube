sudo: required
language: go
notifications:
  email: false

env:
  secure: "hU17t3tJF6QW2Ln1wzwV5QqAXIe62OH5AwFyY0c9/Jl9exUrwlmlYJ0cEpbnj7Hfk+BdSkepSvQYpgeqJ8NIjE+j5CoxtmVhLskVCByGLe/ICd6ZhWQdhIAknkCpPovSvKEjVxRnNvp/7vQXXWLKWx9c7ujk6TuyHAq8Db+45gqcudnhv+9wur17zgBT8lp+qwGlKuMaAmlpJ2cM/B4+32NhXSU8PFcj1+e1jiOVAIx81Yg9jp2XkL3K89gJATkg4th58f3HsdMUp+qK1IvcG5mm4cFIDWPNrkLDkJDK0CftLtU0cOlAQluhIjmKnHNkXhjj7BlS9qGpABiAwkPUYTopLYkwMfISNWUB1kL614LSOVH4fM12B96n6eW9rjRww9jQU2CZI9BH7t7Ox+AMveppZme1JQofTblR8zsEcnieVdGzMfqFhbcwNobkkNx+vMKivyJrXWIOrJBPl2rAE9WiuzMauZHSlC8/J+dBYxHFGXD/x/zi4z2zJB8Xak4FcHQAxWuagZBtqD/ux1S3a3nxRu99namsFHC+1eE/6CA2ZRUSM8aGFunBDjbbPg8/u9vgKlJ46fEfdMeI6Gl8uCTsHqDn+DQsZqOQSKF1JhaRUVSFU2qSanDQVd4hz9IsCo6IYeuvLa4BTLmv+rf4r0NWtf/XI4qSm66qKR/+AtE="

go:
- "1.10.x"

cache:
  directories:
  - /home/travis/.deps
  - /home/travis/.glide
  - /home/travis/vendor

before_install:
# We need glide, etcd and hyperkube
- cd .deps
- wget -N https://github.com/Masterminds/glide/releases/download/v0.13.1/glide-v0.13.1-linux-amd64.zip
- wget -N https://github.com/coreos/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz
- wget -N https://dl.k8s.io/v1.11.2/kubernetes-server-linux-amd64.tar.gz
- wget -N https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz
- sha256sum -c .ci.sha256sum
- unzip glide-v0.13.1-linux-amd64.zip
- mv linux-amd64/glide $GOPATH/bin/ && chmod +x $GOPATH/bin/glide
- cd ..
- mkdir third_party
- tar -xvf .deps/kubernetes-server-linux-amd64.tar.gz
- tar -xvf .deps/etcd-v3.3.9-linux-amd64.tar.gz
- mv kubernetes/server/bin/hyperkube third_party
- mv etcd-v3.3.9-linux-amd64/etcd third_party
- rm -Rf kubernetes
- rm -Rf etcd-v3.3.9-linux-amd64
- cd third_party && tar -xvf ../.deps/cni-plugins-amd64-v0.7.1.tgz && rm ../.deps/cni-plugins-amd64-v0.7.1.tgz && cd ..
- go get golang.org/x/tools/cmd/cover
- go get github.com/mattn/goveralls
- docker run --rm -v /usr/bin:/target jpetazzo/nsenterdocker run --rm

script:
- go test -race -coverprofile=coverage.txt -covermode=atomic -run 'Test[^I][^n]' -v ./...
- go test -race -coverprofile=coverage.txt -covermode=atomic -run 'TestIn' -v ./...

install:
- glide i

after_success:
- goveralls -coverprofile=coverage.txt -service=travis-ci -repotoken $COVERALLS_TOKEN
- bash <(curl -s https://codecov.io/bash)
